<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Subscriptions | Rakkit</title>
    <meta name="description" content="A framework written in TypeScript that provides REST/GraphQL API and Websocket tools to build amazing server-side applications">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
  <link rel="manifest" href="/favicon/site.webmanifest">
  <link rel="mask-icon" href="/favicon/safari-pinned-tab.svg" color="#3a0839">
  <link rel="shortcut icon" href="/favicon/favicon.ico">
  <meta name="msapplication-TileColor" content="#3a0839">
  <meta name="msapplication-config" content="/favicon/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.b5c449e4.css" as="style"><link rel="preload" href="/assets/js/app.cde378e9.js" as="script"><link rel="preload" href="/assets/js/2.d96be7e9.js" as="script"><link rel="preload" href="/assets/js/16.14dd4f7f.js" as="script"><link rel="prefetch" href="/assets/js/10.aecf0b49.js"><link rel="prefetch" href="/assets/js/11.df9dc6e2.js"><link rel="prefetch" href="/assets/js/12.3b278416.js"><link rel="prefetch" href="/assets/js/13.69323374.js"><link rel="prefetch" href="/assets/js/14.38a4229d.js"><link rel="prefetch" href="/assets/js/15.aa7c2e84.js"><link rel="prefetch" href="/assets/js/17.150d4321.js"><link rel="prefetch" href="/assets/js/18.cff99b80.js"><link rel="prefetch" href="/assets/js/19.7b694b98.js"><link rel="prefetch" href="/assets/js/20.ca08d56f.js"><link rel="prefetch" href="/assets/js/21.6a3b9e5f.js"><link rel="prefetch" href="/assets/js/22.7f88cba3.js"><link rel="prefetch" href="/assets/js/23.82ba9afb.js"><link rel="prefetch" href="/assets/js/24.1720b743.js"><link rel="prefetch" href="/assets/js/25.b010b571.js"><link rel="prefetch" href="/assets/js/26.a889ca22.js"><link rel="prefetch" href="/assets/js/27.90a281c7.js"><link rel="prefetch" href="/assets/js/28.e11f2d40.js"><link rel="prefetch" href="/assets/js/29.9045cc84.js"><link rel="prefetch" href="/assets/js/3.22cc39cc.js"><link rel="prefetch" href="/assets/js/30.9cec3ced.js"><link rel="prefetch" href="/assets/js/31.68693ff8.js"><link rel="prefetch" href="/assets/js/32.1990966a.js"><link rel="prefetch" href="/assets/js/33.2a40d71d.js"><link rel="prefetch" href="/assets/js/34.773a0e2f.js"><link rel="prefetch" href="/assets/js/35.15a7eaea.js"><link rel="prefetch" href="/assets/js/36.a096f572.js"><link rel="prefetch" href="/assets/js/37.c47c4bc8.js"><link rel="prefetch" href="/assets/js/38.fd660314.js"><link rel="prefetch" href="/assets/js/39.43aeedbe.js"><link rel="prefetch" href="/assets/js/4.bc2927b0.js"><link rel="prefetch" href="/assets/js/5.e57150a0.js"><link rel="prefetch" href="/assets/js/6.61a82962.js"><link rel="prefetch" href="/assets/js/7.7354f340.js"><link rel="prefetch" href="/assets/js/8.b9aa947b.js"><link rel="prefetch" href="/assets/js/9.e07fc09c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b5c449e4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="Rakkit" class="logo"> <span class="site-name can-hide">Rakkit</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/raccoonch/rakkit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/raccoonch/rakkit" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Getting started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/start/installation.html" class="sidebar-link">Installation</a></li><li><a href="/start/getting-started.html" class="sidebar-link">Getting started</a></li><li><a href="/start/rakkit.html" class="sidebar-link">The Rakkit class</a></li><li><a href="/start/demos.html" class="sidebar-link">Demos</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>GraphQL</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>REST</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Websocket</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Development</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/contributing.html" class="sidebar-link">Contribution</a></li><li><a href="/dev/changelog.html" class="sidebar-link">Changelog</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="subcriptions"><a href="#subcriptions" aria-hidden="true" class="header-anchor">#</a> Subcriptions</h1> <p>GraphQL can be used to perform reads with queries and writes with mutations.
However, oftentimes clients want to get updates pushed to them from the server when data they care about changes.
To support that, GraphQL has a third operation: subscription. Rakkit of course has great support for subscription, using the <a href="https://github.com/apollographql/graphql-subscriptions" target="_blank" rel="noopener noreferrer">graphql-subscriptions<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> package created by <a href="https://www.apollographql.com/" target="_blank" rel="noopener noreferrer">Apollo GraphQL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="creating-subscriptions"><a href="#creating-subscriptions" aria-hidden="true" class="header-anchor">#</a> Creating Subscriptions</h2> <p>Subscription resolvers are similar to <a href="/graphql/query/resolvers.html">queries and mutation resolvers</a> but slightly more complicated.</p> <p>First we create a normal class method as always, but this time annotated with the <code>@Subscription()</code> decorator.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">SampleResolver</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  @<span class="token function">Subscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">newNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Notification <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Then we have to provide the topics we wish to subscribe to. This can be a single topic string, an array of topics or a function to dynamically create a topic based on subscription arguments passed to the query. We can also use TypeScript enums for enhanced type safety.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">SampleResolver</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  @<span class="token function">Subscription</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    topics<span class="token punctuation">:</span> <span class="token string">&quot;NOTIFICATIONS&quot;</span><span class="token punctuation">,</span> <span class="token comment">// single topic</span>
    topics<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;NOTIFICATIONS&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ERRORS&quot;</span><span class="token punctuation">]</span> <span class="token comment">// or topics array</span>
    <span class="token function-variable function">topics</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> args<span class="token punctuation">.</span>topic <span class="token comment">// or dynamic topic function</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">newNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Notification <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We can also provide the <code>filter</code> option to decide which topic events should trigger our subscription.
This function should return a <code>boolean</code> or <code>Promise&lt;boolean&gt;</code> type.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">SampleResolver</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  @<span class="token function">Subscription</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    topics<span class="token punctuation">:</span> <span class="token string">&quot;NOTIFICATIONS&quot;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">filter</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload<span class="token punctuation">,</span> args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> args<span class="token punctuation">.</span>priorities<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">newNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Notification <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We can also provide a custom subscription logic which might be useful, e.g. if we want to use the Prisma subscription functionality or something similar.</p> <p>All we need to do is to use the the <code>subscribe</code> option which should be a function that returns an <code>AsyncIterator</code>. Example using Prisma client subscription feature:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">SampleResolver</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  @<span class="token function">Subscription</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">subscribe</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> args<span class="token punctuation">,</span> context <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> context<span class="token punctuation">.</span>prisma<span class="token punctuation">.</span>$subscribe<span class="token punctuation">.</span><span class="token function">users</span><span class="token punctuation">(</span><span class="token punctuation">{</span> mutation_in<span class="token punctuation">:</span> <span class="token punctuation">[</span>args<span class="token punctuation">.</span>mutationType<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">newNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Notification <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p>Be aware that we can't mix the <code>subscribe</code> option with the <code>topics</code> and <code>filter</code> options. If the filtering is still needed, we can use the <a href="https://github.com/apollographql/graphql-subscriptions#filters" target="_blank" rel="noopener noreferrer"><code>withFilter</code> function<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from the <code>graphql-subscriptions</code> package.</p></div> <p>Now we can implement the subscription resolver. It will receive the payload <strong>before the context</strong>. There, we can transform it to the returned shape.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">SampleResolver</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  @<span class="token function">Subscription</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    topics<span class="token punctuation">:</span> <span class="token string">&quot;NOTIFICATIONS&quot;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">filter</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> payload<span class="token punctuation">,</span> args <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> args<span class="token punctuation">.</span>priorities<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>payload<span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">newNotification</span><span class="token punctuation">(</span>
    @<span class="token function">FlatArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    args<span class="token punctuation">:</span> NewNotificationsArgs<span class="token punctuation">,</span>
    payload<span class="token punctuation">:</span> NotificationPayload<span class="token punctuation">,</span>
    context<span class="token punctuation">:</span> IContext
  <span class="token punctuation">)</span><span class="token punctuation">:</span> Notification <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>payload<span class="token punctuation">,</span>
      date<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="triggering-subscription-topics"><a href="#triggering-subscription-topics" aria-hidden="true" class="header-anchor">#</a> Triggering subscription topics</h2> <p>Ok, we've created subscriptions, but what is the <code>pubsub</code> system and how do we trigger topics?</p> <p>They might be triggered from external sources like a database but also in mutations,
e.g. when we modify some resource that clients want to receive notifications about when it changes.</p> <p>So, let us assume we have this mutation for adding a new comment:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">SampleResolver</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  @<span class="token function">Mutation</span><span class="token punctuation">(</span><span class="token parameter">returns</span> <span class="token operator">=&gt;</span> Boolean<span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">addNewComment</span><span class="token punctuation">(</span>
    @<span class="token function">Arg</span><span class="token punctuation">(</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">)</span>
    input<span class="token punctuation">:</span> CommentInput
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> comment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commentsService<span class="token punctuation">.</span><span class="token function">createNew</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commentsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We use the <code>@PubSub()</code> decorator to inject the <code>pubsub</code> into our method params.
There we can trigger the topics and send the payload to all topic subscribers.</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">class</span> <span class="token class-name">SampleResolver</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  @<span class="token function">Mutation</span><span class="token punctuation">(</span><span class="token parameter">returns</span> <span class="token operator">=&gt;</span> Boolean<span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">addNewComment</span><span class="token punctuation">(</span>
    @<span class="token function">Arg</span><span class="token punctuation">(</span><span class="token string">&quot;comment&quot;</span><span class="token punctuation">)</span>
    input<span class="token punctuation">:</span> CommentInput<span class="token punctuation">,</span>
    context<span class="token punctuation">:</span> IContext
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pubSub <span class="token operator">=</span> context<span class="token punctuation">.</span>gql<span class="token punctuation">.</span>pubSub<span class="token punctuation">;</span>
    <span class="token keyword">const</span> comment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commentsService<span class="token punctuation">.</span><span class="token function">createNew</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commentsRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// here we can trigger subscriptions topics</span>
    <span class="token keyword">const</span> payload<span class="token punctuation">:</span> NotificationPayload <span class="token operator">=</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> input<span class="token punctuation">.</span>content <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> pubSub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;NOTIFICATIONS&quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And that's it! Now all subscriptions attached to the <code>NOTIFICATIONS</code> topic will be triggered when performing the <code>addNewComment</code> mutation.</p> <h2 id="using-a-custom-pubsub-system"><a href="#using-a-custom-pubsub-system" aria-hidden="true" class="header-anchor">#</a> Using a custom PubSub system</h2> <p>By default, Rakkit uses a simple <code>PubSub</code> system from <code>grapqhl-subscriptions</code> which is based on EventEmitter.
This solution has a big drawback in that it will work correctly only when we have a single instance (process) of our Node.js app.</p> <p>For better scalability we'll want to use one of the <a href="https://github.com/apollographql/graphql-subscriptions#pubsub-implementations" target="_blank" rel="noopener noreferrer"><code>PubSub implementations</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> backed by an external store like Redis with the <a href="https://github.com/davidyaha/graphql-redis-subscriptions" target="_blank" rel="noopener noreferrer"><code>graphql-redis-subscriptions</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> package.</p> <p>All we need to do is create an instance of PubSub according to the package instructions and then provide it to the <code>Rakkit.start</code> options:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> myRedisPubSub <span class="token operator">=</span> <span class="token function">getConfiguredRedisPubSub</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Rakkit<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  gql<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    resolvers<span class="token punctuation">:</span> <span class="token punctuation">[</span>__dirname <span class="token operator">+</span> <span class="token string">&quot;/**/*.resolver.ts&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pubSub<span class="token punctuation">:</span> myRedisPubSub
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="creating-a-subscription-server"><a href="#creating-a-subscription-server" aria-hidden="true" class="header-anchor">#</a> Creating a Subscription Server</h2> <p>The <a href="/graphql/query/bootstrap.html">bootstrap guide</a> and all the earlier examples used <a href="https://github.com/apollographql/apollo-server" target="_blank" rel="noopener noreferrer"><code>apollo-server</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to create an HTTP endpoint for our GraphQL API.</p> <p>Fortunately, to make subscriptions work, we don't need to manually provide a transport layer that doesn't have constraints of HTTP and can do a push-based communication (WebSockets).
The <code>apollo-server</code> package has built-in subscriptions support using websockets, so it works out of the box without any changes to our bootstrap config. However, if we want, we can provide the <code>subscriptions</code> property of the config object:</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// Create GraphQL server</span>
<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApolloServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  schema<span class="token punctuation">,</span>
  subscriptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">:</span> <span class="token string">&quot;/subscriptions&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// other options and hooks, like `onConnect`</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>And it's done! We have a working GraphQL subscription server on <code>/subscriptions</code>, along with the normal HTTP GraphQL server.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/raccoonch/rakkit/edit/master/docs/graphql/query/subscriptions.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/graphql/query/middlewares.html" class="prev">
          Middlewares
        </a></span> <span class="next"><a href="/graphql/misc/write-schema.html">
          Emitting the schema SDL
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cde378e9.js" defer></script><script src="/assets/js/2.d96be7e9.js" defer></script><script src="/assets/js/16.14dd4f7f.js" defer></script>
  </body>
</html>
